<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permission Management - Apt. Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <!-- Fixed Top Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 h-16 bg-slate-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-3">
                <a href="/" class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center">
                        <span class="font-bold text-lg">A</span>
                    </div>
                    <span class="font-bold text-lg tracking-tight hidden sm:block">Apt. Tracker</span>
                    <span class="font-bold text-lg tracking-tight sm:hidden">Tracker</span>
                </a>
            </div>

            <!-- Desktop Navigation Links -->
            <div class="hidden md:flex items-center gap-1">
                <a href="/" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="layout-dashboard" class="w-[18px] h-[18px]"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="users" class="w-[18px] h-[18px]"></i>
                    <span>Users</span>
                </a>
                <a href="/admin/roles" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="shield" class="w-[18px] h-[18px]"></i>
                    <span>Roles</span>
                </a>
                <a href="/admin/permissions" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-indigo-600 text-white shadow-md shadow-indigo-900/20">
                    <i data-lucide="key" class="w-[18px] h-[18px]"></i>
                    <span>Permissions</span>
                </a>
            </div>

            <!-- Right Side: Profile & Mobile Toggle -->
            <div class="flex items-center gap-4">
                <!-- User Profile (Desktop) -->
                <div class="hidden md:flex items-center pl-4  relative">
                    <button id="profileDropdownBtn" class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300 border border-slate-600 hover:bg-slate-600 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-slate-500" title="Profile Menu">
                        <%= user.username ? user.username.substring(0, 2).toUpperCase() : 'U' %>
                    </button>
                    <!-- Profile Dropdown Menu -->
                    <div id="profileDropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-slate-800 rounded-lg shadow-xl border border-slate-700 overflow-hidden z-50">
                        <div class="px-4 py-3 border-b border-slate-700">
                            <p class="text-sm font-medium text-white"><%= user.username %></p>
                            <p class="text-xs text-slate-400"><%= user.roleName %></p>
                        </div>
                        <a href="/auth/logout" class="flex items-center gap-2 px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-800">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 pt-24 pb-8">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-slate-900">Permission Management</h1>
            <p class="text-slate-500 mt-1">View all available permissions in the system</p>
            <p class="text-xs text-slate-400 mt-2">Note: Permissions are system-defined and cannot be modified through the UI</p>
        </div>

        <!-- Permissions Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100 text-xs uppercase text-slate-500 font-semibold">
                        <tr>
                            <th class="px-6 py-4">Permission Name</th>
                            <th class="px-6 py-4">Resource</th>
                            <th class="px-6 py-4">Action</th>
                            <th class="px-6 py-4">Description</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-sm" id="permissionsTableBody">
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-slate-400">Loading permissions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Load permissions
        async function loadPermissions() {
            try {
                const response = await fetch('/admin/api/permissions');
                if (!response.ok) throw new Error('Failed to fetch permissions');
                const permissions = await response.json();

                // Group by resource
                const grouped = {};
                permissions.forEach(perm => {
                    if (!grouped[perm.resource]) grouped[perm.resource] = [];
                    grouped[perm.resource].push(perm);
                });

                const tbody = document.getElementById('permissionsTableBody');
                if (permissions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">No permissions found</td></tr>';
                    return;
                }

                tbody.innerHTML = Object.entries(grouped).map(([resource, perms]) => 
                    perms.map((perm, index) => `
                        <tr class="${index === 0 ? 'border-t-2 border-slate-200' : ''}">
                            ${index === 0 ? `<td class="px-6 py-4 font-semibold text-slate-700 capitalize" rowspan="${perms.length}">${resource}</td>` : ''}
                            <td class="px-6 py-4 font-mono text-xs text-slate-600">${perm.name}</td>
                            <td class="px-6 py-4 text-slate-500 capitalize">${perm.action}</td>
                            <td class="px-6 py-4 text-slate-600">${perm.description || 'No description'}</td>
                        </tr>
                    `).join('')
                ).join('');
            } catch (error) {
                console.error('Error loading permissions:', error);
                document.getElementById('permissionsTableBody').innerHTML = 
                    '<tr><td colspan="4" class="px-6 py-8 text-center text-red-400">Error loading permissions</td></tr>';
            }
        }

        // Initialize
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        loadPermissions();
        
        // Profile dropdown toggle
        (function() {
            const profileBtn = document.getElementById('profileDropdownBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            
            if (profileBtn && profileDropdown) {
                // Toggle dropdown on button click
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isHidden = profileDropdown.classList.toggle('hidden');
                    if (!isHidden && typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
                
                // Close dropdown on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }
        })();
    </script>
</body>
</html>

