<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apt. Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr MonthSelect Plugin CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .notification {
            transition: opacity 0.3s ease-in-out;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .view-hidden {
            display: none !important;
        }
        /* Print-specific styles for mobile-friendly PDF */
        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
        }
        .print-container {
            max-width: 100%;
            padding: 20px;
            background: white;
        }
        .print-container table {
            width: 100%;
            font-size: 12px;
        }
        .print-container th,
        .print-container td {
            padding: 8px 4px;
            text-align: left;
        }
        .print-container th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <!-- Fixed Top Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 h-16 bg-slate-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center">
                    <span class="font-bold text-lg">A</span>
                </div>
                <span class="font-bold text-lg tracking-tight hidden sm:block">Apt. Tracker</span>
                <span class="font-bold text-lg tracking-tight sm:hidden">Tracker</span>
            </div>

            <!-- Desktop Navigation Links -->
            <div class="hidden md:flex items-center gap-2">
                <button data-tab="dashboard" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-indigo-600 text-white shadow-md shadow-indigo-900/20">
                    <i data-lucide="layout-dashboard" class="w-[18px] h-[18px]"></i>
                    <span>Dashboard</span>
                </button>
                <button data-tab="collections" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="wallet" class="w-[18px] h-[18px]"></i>
                    <span>Collections</span>
                </button>
                <button data-tab="expenses" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="receipt" class="w-[18px] h-[18px]"></i>
                    <span>Expenses</span>
                </button>
                <button data-tab="activity" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="activity" class="w-[18px] h-[18px]"></i>
                    <span>Activity</span>
                </button>
                <% if (typeof permissions !== 'undefined' && permissions.includes('view_reports')) { %>
                <button data-tab="reports" class="nav-tab flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800">
                    <i data-lucide="file-text" class="w-[18px] h-[18px]"></i>
                    <span>Reports</span>
                </button>
                <% } %>
                <% if (typeof user !== 'undefined' && user && user.roleName === 'Admin') { %>
                <a href="/admin/users" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-800" title="Admin Panel">
                    <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
                    <span>Admin</span>
                </a>
                <% } %>
            </div>

            <!-- Right Side: Profile & Mobile Toggle -->
            <div class="flex items-center gap-4">
                <!-- User Profile (Desktop) -->
                <div class="hidden md:flex items-center pl-4  relative">
                    <button id="profileDropdownBtn" class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300 border border-slate-600 hover:bg-slate-600 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-slate-500" title="Profile Menu">
                        <%= typeof user !== 'undefined' && user && user.username ? user.username.substring(0, 2).toUpperCase() : 'U' %>
                    </button>
                    <!-- Profile Dropdown Menu -->
                    <div id="profileDropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-slate-800 rounded-lg shadow-xl border border-slate-700 overflow-hidden z-50">
                        <div class="px-4 py-3 border-b border-slate-700">
                            <p class="text-sm font-medium text-white"><%= typeof user !== 'undefined' && user ? user.username : 'User' %></p>
                            <p class="text-xs text-slate-400"><%= typeof user !== 'undefined' && user ? user.roleName : 'Role' %></p>
                        </div>
                        <a href="/auth/logout" class="flex items-center gap-2 px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-800">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Overlay & Drawer -->
    <div id="mobileMenu" class="fixed inset-0 z-50 md:hidden view-hidden">
        <!-- Backdrop -->
        <div id="mobileMenuBackdrop" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        
        <!-- Drawer -->
        <div class="absolute right-0 top-0 bottom-0 w-64 bg-slate-900 shadow-2xl p-6 transform transition-transform duration-200 flex flex-col">
            <div class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                <span class="font-bold text-xl text-white">Menu</span>
                <button id="closeMobileMenu" class="text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-2 flex-1">
                <button data-tab="dashboard" class="mobile-nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-indigo-600 text-white">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </button>
                <button data-tab="collections" class="mobile-nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span>Collections</span>
                </button>
                <button data-tab="expenses" class="mobile-nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    <span>Expenses</span>
                </button>
                <button data-tab="activity" class="mobile-nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                    <span>Activity</span>
                </button>
                <% if (typeof permissions !== 'undefined' && permissions.includes('view_reports')) { %>
                <button data-tab="reports" class="mobile-nav-tab w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span>Reports</span>
                </button>
                <% } %>
                <% if (typeof user !== 'undefined' && user && user.roleName === 'Admin') { %>
                <a href="/admin/users" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-800 hover:text-white">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Admin</span>
                </a>
                <% } %>
            </div>
            
            <!-- User Profile (Mobile Footer) -->
            <div class="pt-4 border-t border-slate-800">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300">
                        <%= typeof user !== 'undefined' && user && user.username ? user.username.substring(0, 2).toUpperCase() : 'U' %>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-white"><%= typeof user !== 'undefined' && user ? user.username : 'User' %></p>
                        <p class="text-xs text-slate-500"><%= typeof user !== 'undefined' && user ? user.roleName : 'Role' %></p>
                    </div>
                </div>
                <a href="/auth/logout" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-800 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification" class="notification fixed top-20 right-4 z-50 hidden">
        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg" id="notification-content">
            Success!
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full max-w-7xl mx-auto pt-24 px-4 pb-4 md:px-8 md:pb-8">
        <!-- Dashboard View -->
        <div id="dashboardView" class="space-y-6">
            <!-- Date Filter & Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Dashboard</h2>
                    <p class="text-slate-500">Overview for Greenpeace Willowbrook</p>
                </div>
                <div class="flex items-center gap-3 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                    <button id="prevMonth" class="p-1 hover:bg-slate-100 rounded">←</button>
                    <input type="text" id="monthSelector" readonly placeholder="Select Month" class="border-none focus:ring-0 text-sm font-medium text-slate-700 bg-transparent cursor-pointer">
                    <button id="nextMonth" class="p-1 hover:bg-slate-100 rounded">→</button>
                </div>
            </div>

            <!-- Apartment Image Banner -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <img src="/images/appartment.jpg" alt="Willowbrook Apartment Building" class="w-full h-64 object-cover">
            </div>

            <!-- Stats Grid -->
            <div class="space-y-4">
                <!-- Top Row: Current Balance & Total Corpus Fund -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Current Balance</p>
                            <h3 class="text-2xl font-bold text-slate-900" id="currentBalance">₹0</h3>
                            <p class="text-xs text-slate-400 mt-1">Income - Expenses (All Time)</p>
                        </div>
                        <div class="p-3 rounded-xl bg-indigo-50">
                            <i data-lucide="wallet" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Total Corpus Fund</p>
                            <h3 class="text-2xl font-bold text-slate-900" id="totalCorpusFund">₹0</h3>
                            <p class="text-xs text-slate-400 mt-1">Lifetime accumulation</p>
                        </div>
                        <div class="p-3 rounded-xl bg-amber-50">
                            <i data-lucide="piggy-bank" class="w-6 h-6 text-amber-600"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Row: Maintenance Collected, Corpus Collected, Total Expenses -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Maintenance Collected</p>
                            <h3 class="text-2xl font-bold text-slate-900" id="maintenanceCollected">₹0</h3>
                            <p class="text-xs text-slate-400 mt-1">From residents this month</p>
                        </div>
                        <div class="p-3 rounded-xl bg-emerald-50">
                            <i data-lucide="trending-up" class="w-6 h-6 text-emerald-600"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Corpus Collected</p>
                            <h3 class="text-2xl font-bold text-slate-900" id="corpusCollected">₹0</h3>
                            <p class="text-xs text-slate-400 mt-1">From residents this month</p>
                        </div>
                        <div class="p-3 rounded-xl bg-amber-50">
                            <i data-lucide="piggy-bank" class="w-6 h-6 text-amber-600"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">Total Expenses</p>
                            <h3 class="text-2xl font-bold text-slate-900" id="totalExpenses">₹0</h3>
                            <p class="text-xs text-slate-400 mt-1">Utilities & Services this Month</p>
                        </div>
                        <div class="p-3 rounded-xl bg-rose-50">
                            <i data-lucide="trending-down" class="w-6 h-6 text-rose-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Monthly Trends Chart -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Monthly Trends</h3>
                    <div class="h-64">
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>
                
                <!-- Expense Categories Chart -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Expense Categories</h3>
                    <div class="h-64">
                        <canvas id="expenseCategoriesChart"></canvas>
                    </div>
                </div>
                
                <!-- Income vs Expenses Chart -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Maintenance Income vs Expenses</h3>
                    <div class="h-64">
                        <canvas id="incomeExpensesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="grid grid-cols-2 gap-4">
                <% if (typeof permissions !== 'undefined' && permissions.includes('add_collection')) { %>
                <button id="addCollectionBtn" class="flex items-center justify-center gap-2 p-4 rounded-xl bg-white border border-emerald-100 text-emerald-700 shadow-sm hover:shadow-md hover:border-emerald-200 transition-all group">
                    <div class="bg-emerald-100 p-2 rounded-full group-hover:bg-emerald-200 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold">Add Collection</span>
                </button>
                <% } else { %>
                <div></div>
                <% } %>
                <% if (typeof permissions !== 'undefined' && permissions.includes('add_expense')) { %>
                <button id="addExpenseBtn" class="flex items-center justify-center gap-2 p-4 rounded-xl bg-white border border-rose-100 text-rose-700 shadow-sm hover:shadow-md hover:border-rose-200 transition-all group">
                    <div class="bg-rose-100 p-2 rounded-full group-hover:bg-rose-200 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </div>
                    <span class="font-semibold">Add Expense</span>
                </button>
                <% } %>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-semibold text-slate-800">Recent Activity</h3>
                    <button data-tab="activity" class="text-sm text-indigo-600 font-medium hover:text-indigo-700">View All</button>
                </div>
                <div class="divide-y divide-slate-100" id="recentActivity">
                    <div class="p-8 text-center text-slate-400">
                        No transactions recorded yet.
                    </div>
                </div>
            </div>
        </div>

        <!-- Collections View -->
        <div id="collectionsView" class="space-y-6 view-hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Collections</h2>
                    <p class="text-slate-500">History of all maintenance & corpus payments</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-3 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                        <button id="prevMonthCollections" class="p-1 hover:bg-slate-100 rounded">←</button>
                        <input type="text" id="monthSelectorCollections" readonly placeholder="Select Month" class="border-none focus:ring-0 text-sm font-medium text-slate-700 bg-transparent cursor-pointer w-32">
                        <button id="nextMonthCollections" class="p-1 hover:bg-slate-100 rounded">→</button>
                    </div>
                    <% if (typeof permissions !== 'undefined' && permissions.includes('add_collection')) { %>
                    <button id="addCollectionBtn2" class="hidden sm:flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                        <i data-lucide="plus" class="w-[18px] h-[18px]"></i>
                        <span>Add New</span>
                    </button>
                    <% } %>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 text-xs uppercase text-slate-500 font-semibold">
                            <tr>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Flat No.</th>
                                <th class="px-6 py-4">Type</th>
                                <th class="px-6 py-4">Payment</th>
                                <th class="px-6 py-4 text-right">Amount</th>
                                <th class="px-6 py-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm" id="collectionsTableBody">
                            <tr>
                                <td colSpan="6" class="px-6 py-8 text-center text-slate-400">No collections found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses View -->
        <div id="expensesView" class="space-y-6 view-hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Expenses</h2>
                    <p class="text-slate-500">Track spending on utilities and repairs</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-3 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                        <button id="prevMonthExpenses" class="p-1 hover:bg-slate-100 rounded">←</button>
                        <input type="text" id="monthSelectorExpenses" readonly placeholder="Select Month" class="border-none focus:ring-0 text-sm font-medium text-slate-700 bg-transparent cursor-pointer w-32">
                        <button id="nextMonthExpenses" class="p-1 hover:bg-slate-100 rounded">→</button>
                    </div>
                    <% if (typeof permissions !== 'undefined' && permissions.includes('add_expense')) { %>
                    <button id="addExpenseBtn2" class="hidden sm:flex items-center gap-2 bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 transition-colors shadow-lg shadow-rose-200">
                        <i data-lucide="plus" class="w-[18px] h-[18px]"></i>
                        <span>Add New</span>
                    </button>
                    <% } %>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 text-xs uppercase text-slate-500 font-semibold">
                            <tr>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Category</th>
                                <th class="px-6 py-4">Description</th>
                                <th class="px-6 py-4">Deduct From</th>
                                <th class="px-6 py-4">Payment</th>
                                <th class="px-6 py-4 text-right">Amount</th>
                                <th class="px-6 py-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm" id="expensesTableBody">
                            <tr>
                                <td colSpan="7" class="px-6 py-8 text-center text-slate-400">No expenses found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reportsView" class="space-y-6 view-hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Monthly Report</h2>
                    <p class="text-slate-500 mt-1">Collections, Expenses, and Balance for Selected Month</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-3 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                        <button id="prevMonthReports" class="p-1 hover:bg-slate-100 rounded">←</button>
                        <input type="text" id="monthSelectorReports" readonly placeholder="Select Month" class="border-none focus:ring-0 text-sm font-medium text-slate-700 bg-transparent cursor-pointer w-32">
                        <button id="nextMonthReports" class="p-1 hover:bg-slate-100 rounded">→</button>
                    </div>
                    <button id="printReportBtn" class="no-print flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                        <i data-lucide="printer" class="w-[18px] h-[18px]"></i>
                        <span class="hidden sm:inline">Print PDF</span>
                    </button>
                </div>
            </div>

            <!-- Balance Summary - First -->
            <div class="bg-white rounded-2xl shadow-lg p-4">
                <h3 class="text-base font-semibold text-slate-900 mb-3">Balance Summary</h3>
                <div class="space-y-3">
                    <!-- Maintenance Section -->
                    <div>
                        <h4 class="text-xs font-semibold text-slate-700 uppercase tracking-wider mb-2">Maintenance</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <!-- Maintenance Collections -->
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-xs text-slate-500 mb-1">Collections</p>
                                <p id="totalMaintenanceCollectionsAmount" class="text-lg font-bold text-slate-900">₹0</p>
                            </div>
                            <!-- Maintenance Expenses -->
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-xs text-slate-500 mb-1">Expenses</p>
                                <p id="totalMaintenanceExpensesAmount" class="text-lg font-bold text-red-600">₹0</p>
                            </div>
                            <!-- Previous Month Balance (Maintenance) -->
                            <div class="bg-blue-50 rounded-lg p-3" id="maintenancePreviousBalanceCard">
                                <p class="text-xs text-blue-600 mb-1">Prev Month Balance</p>
                                <p id="maintenancePreviousBalanceAmount" class="text-lg font-bold text-blue-900">₹0</p>
                            </div>
                            <!-- Maintenance Balance -->
                            <div class="bg-indigo-50 rounded-lg p-3" id="maintenanceBalanceCard">
                                <p class="text-xs text-indigo-600 mb-1">Balance</p>
                                <p id="balanceAmount" class="text-lg font-bold text-indigo-900">₹0</p>
                            </div>
                        </div>
                    </div>
                    <!-- Corpus Section -->
                    <div>
                        <h4 class="text-xs font-semibold text-slate-700 uppercase tracking-wider mb-2">Corpus</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <!-- Corpus Collections -->
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-xs text-slate-500 mb-1">Collections</p>
                                <p id="totalCorpusCollectionsAmount" class="text-lg font-bold text-slate-900">₹0</p>
                            </div>
                            <!-- Corpus Expenses -->
                            <div class="bg-slate-50 rounded-lg p-3">
                                <p class="text-xs text-slate-500 mb-1">Expenses</p>
                                <p id="totalCorpusExpensesAmount" class="text-lg font-bold text-red-600">₹0</p>
                            </div>
                            <!-- Previous Month Balance (Corpus) -->
                            <div class="bg-blue-50 rounded-lg p-3" id="corpusPreviousBalanceCard">
                                <p class="text-xs text-blue-600 mb-1">Prev Month Balance</p>
                                <p id="corpusPreviousBalanceAmount" class="text-lg font-bold text-blue-900">₹0</p>
                            </div>
                            <!-- Corpus Balance -->
                            <div class="bg-amber-50 rounded-lg p-3" id="corpusBalanceCard">
                                <p class="text-xs text-amber-600 mb-1">Balance</p>
                                <p id="corpusBalanceAmount" class="text-lg font-bold text-amber-900">₹0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collections and Expenses Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Combined Collections Section -->
                <div class="flex flex-col h-full">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">Collections</h3>
                        <p class="text-sm text-slate-500">Monthly Maintenance & Corpus Collections per House</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6 flex-1 flex flex-col">
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-slate-50 border-b border-slate-200">
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">House/Flat</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Maintenance</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Corpus</th>
                                    </tr>
                                </thead>
                                <tbody id="combinedCollectionsTableBody" class="bg-white divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="3" class="px-4 py-8 text-center text-slate-400">Loading reports...</td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-slate-50">
                                    <tr class="font-semibold">
                                        <td class="px-4 py-4 text-left text-slate-900">Total</td>
                                        <td id="totalMaintenanceCollections" class="px-4 py-4 text-right text-slate-900">₹0</td>
                                        <td id="totalCorpusCollections" class="px-4 py-4 text-right text-slate-900">₹0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Expenses Section -->
                <div class="flex flex-col h-full">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">Maintenance Expenses</h3>
                        <p class="text-sm text-slate-500">Monthly Maintenance Expenses by Category</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6 flex-1 flex flex-col">
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-slate-50 border-b border-slate-200">
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Category</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceExpensesTableBody" class="bg-white divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="2" class="px-4 py-8 text-center text-slate-400">Loading reports...</td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-slate-50">
                                    <tr class="font-semibold">
                                        <td class="px-4 py-4 text-left text-slate-900">Total</td>
                                        <td id="totalMaintenanceExpenses" class="px-4 py-4 text-right text-slate-900">₹0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Corpus Expenses Section -->
                <div class="flex flex-col h-full">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">Corpus Expenses</h3>
                        <p class="text-sm text-slate-500">Monthly Corpus Expenses by Category</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6 flex-1 flex flex-col">
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-slate-50 border-b border-slate-200">
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Category</th>
                                        <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="corpusExpensesTableBody" class="bg-white divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="2" class="px-4 py-8 text-center text-slate-400">Loading reports...</td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-slate-50">
                                    <tr class="font-semibold">
                                        <td class="px-4 py-4 text-left text-slate-900">Total</td>
                                        <td id="totalCorpusExpenses" class="px-4 py-4 text-right text-slate-900">₹0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity View -->
        <div id="activityView" class="space-y-6 view-hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Recent Activity</h2>
                    <p class="text-slate-500 mt-1">All transactions and activities</p>
                </div>
            </div>

            <!-- Activity Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Flat/Category</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Payment Mode</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="allActivitiesTableBody" class="bg-white divide-y divide-slate-200">
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-slate-400">Loading activities...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Collection Modal -->
    <div id="collectionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-semibold text-slate-800">Add New Collection</h3>
                <button id="closeCollectionModal" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="collectionForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Date</label>
                        <div class="relative">
                            <input type="text" id="collectionDate" required placeholder="Select Date" class="w-full px-3 py-2 pr-10 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-colors" readonly>
                            <i data-lucide="calendar" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Amount (₹)</label>
                        <input type="number" id="collectionAmount" required min="0" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-colors">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Collection Type</label>
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-lg">
                        <button type="button" id="collectionTypeMaintenance" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all bg-white text-indigo-600 shadow-sm">
                            Maintenance
                        </button>
                        <button type="button" id="collectionTypeCorpus" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-slate-500 hover:text-slate-700">
                            Corpus Fund
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Flat Number / Unit</label>
                    <select id="collectionFlatNumber" required class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 bg-white">
                        <option value="1A">1A</option>
                        <option value="2A">2A</option>
                        <option value="3A">3A</option>
                        <option value="4A">4A</option>
                        <option value="1B">1B</option>
                        <option value="2B">2B</option>
                        <option value="3B">3B</option>
                        <option value="4B">4B</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Description (Optional)</label>
                    <input type="text" id="collectionDescription" placeholder="e.g. November Maintenance" class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-colors">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Payment Mode</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="collectionPaymentMode" value="Online" checked class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-slate-700">Online</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="collectionPaymentMode" value="Cash" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-slate-700">Cash</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="collectionPaymentMode" value="Cheque" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-slate-700">Cheque</span>
                        </label>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full py-2.5 px-4 rounded-xl text-white font-medium shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all bg-gradient-to-r from-emerald-500 to-teal-500 shadow-emerald-500/25">
                        Record Collection
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="expenseModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-semibold text-slate-800">Add New Expense</h3>
                <button id="closeExpenseModal" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="expenseForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Date</label>
                        <div class="relative">
                            <input type="text" id="expenseDate" required placeholder="Select Date" class="w-full px-3 py-2 pr-10 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-colors" readonly>
                            <i data-lucide="calendar" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">Amount (₹)</label>
                        <input type="number" id="expenseAmount" required min="0" placeholder="0.00" class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-colors">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Category</label>
                    <select id="expenseCategory" required class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 bg-white">
                        <option>Electricity</option>
                        <option>Water Tanker</option>
                        <option>Cleaning</option>
                        <option>Security</option>
                        <option>Repairs</option>
                        <option>Gardening</option>
                        <option>Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Description (Optional)</label>
                    <input type="text" id="expenseDescription" placeholder="e.g. November Maintenance" class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-colors">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Deduct From</label>
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-lg">
                        <button type="button" id="expenseDeductionMaintenance" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all bg-white text-indigo-600 shadow-sm">
                            Maintenance
                        </button>
                        <button type="button" id="expenseDeductionCorpus" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-slate-500 hover:text-slate-700">
                            Corpus Fund
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Payment Mode</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="expensePaymentMode" value="Online" checked class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-slate-700">Online</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="expensePaymentMode" value="Cash" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-slate-700">Cash</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="expensePaymentMode" value="Cheque" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-slate-700">Cheque</span>
                        </label>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full py-2.5 px-4 rounded-xl text-white font-medium shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all bg-gradient-to-r from-rose-500 to-pink-500 shadow-rose-500/25">
                        Record Expense
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floating Action Button (Mobile Only) -->
    <div class="md:hidden fixed bottom-6 right-6 z-40 flex flex-col gap-3">
        <% if (typeof permissions !== 'undefined' && permissions.includes('add_expense')) { %>
        <button id="mobileAddExpenseBtn" class="w-12 h-12 rounded-full bg-rose-600 text-white flex items-center justify-center shadow-lg shadow-rose-600/30 active:scale-95 transition-all">
            <i data-lucide="receipt" class="w-5 h-5"></i>
        </button>
        <% } %>
        <% if (typeof permissions !== 'undefined' && permissions.includes('add_collection')) { %>
        <button id="mobileAddCollectionBtn" class="w-14 h-14 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg shadow-indigo-600/30 active:scale-95 transition-all">
            <i data-lucide="plus" class="w-7 h-7"></i>
        </button>
        <% } %>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr MonthSelect Plugin JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <!-- Server-provided configuration (from .env) -->
    <script>
        window.SERVER_ENV_CONFIG = <%- JSON.stringify(appConfig || {}) %>;
        // User permissions for client-side checks
        window.USER_PERMISSIONS = <%- JSON.stringify(typeof permissions !== 'undefined' ? permissions : []) %>;
        
        // Helper function to check permissions in JavaScript
        function hasPermission(permissionName) {
            return window.USER_PERMISSIONS && window.USER_PERMISSIONS.includes(permissionName);
        }
    </script>
    <!-- Configuration File -->
    <script src="/config/config.js"></script>
    <!-- Main Application Script -->
    <script src="/script.js"></script>
    <script>
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        
        // Profile dropdown toggle
        (function() {
            const profileBtn = document.getElementById('profileDropdownBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            
            if (profileBtn && profileDropdown) {
                // Toggle dropdown on button click
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isHidden = profileDropdown.classList.toggle('hidden');
                    if (!isHidden && typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                });
                
                // Close dropdown on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        profileDropdown.classList.add('hidden');
                    }
                });
            }
        })();
    </script>
</body>
</html>


